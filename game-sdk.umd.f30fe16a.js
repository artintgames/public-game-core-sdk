(function(c,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(c=typeof globalThis<"u"?globalThis:c||self,p(c.coreSDK={}))})(this,(function(c){"use strict";var p=typeof document<"u"?document.currentScript:null;const K={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};function N(s){if(typeof process<"u"&&process.env){const e=process.env[s];if(e)return e}if(typeof{url:typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__filename).href:typeof document>"u"?location.href:p&&p.tagName.toUpperCase()==="SCRIPT"&&p.src||new URL("game-sdk.umd.js",document.baseURI).href}<"u"&&K){const e=K[s];if(e)return e}if(typeof window<"u"&&window.__ENV__){const e=window.__ENV__[s];if(e)return e}}const pe=N("REACT_APP_BACKEND_URL"),me=N("REACT_APP_BACKEND_URL_AUTH"),m={baseUrl:pe,authUrl:me};function B(s){m.baseUrl=s}function $(s){m.authUrl=s}const G="coreSDK_profiles_v1",Se=100,q=300*1e3,ye=600*1e3;class _e{constructor(e){this.items=new Map,this.maxItems=e?.maxItems??Se,this.loadFromStorage()}get(e){const t=this.items.get(e);if(!t)return null;const n=Date.now();return n-t.cachedAt>t.ttl?(this.items.delete(e),this.saveToStorageSafe(),null):(t.lastAccessed=n,t.profile)}set(e,t){const n=Date.now(),i={profile:e,cachedAt:n,lastAccessed:n,ttl:t};this.items.set(e.gid,i),this.evictIfNeeded(),this.saveToStorageSafe()}invalidate(e){this.items.delete(e)&&this.saveToStorageSafe()}invalidateAll(){this.items.clear(),this.saveToStorageSafe()}evictIfNeeded(){if(this.items.size<=this.maxItems)return;const e=Array.from(this.items.entries());e.sort((n,i)=>n[1].lastAccessed-i[1].lastAccessed);const t=e.length-this.maxItems;for(let n=0;n<t;n++){const[i]=e[n];this.items.delete(i)}}loadFromStorage(){if(!(typeof localStorage>"u"))try{const e=localStorage.getItem(G);if(!e)return;const t=JSON.parse(e);if(t.version!==1||!t.items||typeof t.items!="object")return;const n=Date.now();for(const[i,r]of Object.entries(t.items))!r||!r.profile||typeof r.cachedAt!="number"||typeof r.ttl!="number"||n-r.cachedAt>r.ttl||this.items.set(i,r);this.evictIfNeeded()}catch(e){console.error("[ProfileCache] loadFromStorage error:",e)}}saveToStorageSafe(){if(!(typeof localStorage>"u"))try{const e={};for(const[n,i]of this.items.entries())e[n]=i;const t={version:1,items:e};localStorage.setItem(G,JSON.stringify(t))}catch(e){console.error("[ProfileCache] saveToStorageSafe error:",e)}}}const I={PROFILE_UPDATED:"profile.updated"};class F{constructor(e,t){this.cache=new _e,this.meGid=null,this.getAuthToken=e,this.events=t}buildUrl(e){const t=m.authUrl.replace(/\/+$/,""),n=e.replace(/^\/+/,"");return`${t}/${n}`}async request(e,t={}){const n=this.buildUrl(e),i=this.getAuthToken(),r={"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`);const a=await fetch(n,{...t,headers:r,credentials:"include"});if(!a.ok){const l=await a.text();let d=`Request failed with status ${a.status}`;try{const o=JSON.parse(l);Array.isArray(o.message)?d=o.message.join(", "):o.message?d=o.message:o.error&&(d=o.error)}catch{}throw new Error(d)}const u=await a.text();return u?JSON.parse(u):null}async getMe(){if(this.meGid){const t=this.cache.get(this.meGid);if(t)return t}const e=await this.request("/v1/profile/me");return this.meGid=e.gid,this.cache.set(e,q),e}async getByGid(e){if(this.meGid===e)return this.getMe();const t=this.cache.get(e);if(t)return t;const n=await this.request(`/v1/profile/${e}`);return this.cache.set(n,ye),n}async update(e){const t=await this.request("/v1/profile/me",{method:"PUT",body:JSON.stringify(e)});return this.meGid=t.gid,this.cache.set(t,q),this.events.emit(I.PROFILE_UPDATED,{gid:t.gid,profile:t}),typeof window<"u"&&window.dispatchEvent(new CustomEvent(I.PROFILE_UPDATED,{detail:{gid:t.gid,profile:t}})),t}async getSummary(e){let t=e;return t||(t=(await this.getMe()).gid),this.request(`/v1/profile/${t}/summary`)}async getSummaryBatch(e){return(await this.request("/v1/profile/batch",{method:"POST",body:JSON.stringify({gids:e})})).profiles??[]}invalidate(e){this.cache.invalidate(e)}invalidateAll(){this.cache.invalidateAll()}}class H{constructor(e){this.getAuthToken=e}buildUrl(e){const t=m.baseUrl.replace(/\/+$/,""),n=e.replace(/^\/+/,"");return`${t}/${n}`}async request(e,t={}){const n=this.buildUrl(e),i=this.getAuthToken(),r={"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`),console.log("[API] REQUEST:",{url:n,method:t.method??"GET",headers:r,body:t.body});const a=await fetch(n,{...t,headers:r,credentials:"include"});if(!a.ok){const l=await a.text().catch(()=>"");throw console.error("[API] Request failed:",{url:n,status:a.status,body:l}),new Error(`Request failed with status ${a.status}`)}const u=await a.text();if(!u)return null;try{return JSON.parse(u)}catch(l){return console.warn("[API] Response is not JSON, returning as text:",l),u}}normalizeBody(e){return e===void 0?void 0:JSON.stringify(e)}send(e,t,n){return this.request(t,{method:e,body:this.normalizeBody(n)})}get(e){return this.send("GET",e)}post(e,t){return this.send("POST",e,t)}put(e,t){return this.send("PUT",e,t)}patch(e,t){return this.send("PATCH",e,t)}delete(e){return this.send("DELETE",e)}}class x{constructor(){this.listeners=new Map,this.onceListeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}once(e,t){this.onceListeners.has(e)||this.onceListeners.set(e,new Set),this.onceListeners.get(e).add(t)}off(e,t){this.listeners.get(e)?.delete(t),this.onceListeners.get(e)?.delete(t)}emit(e,...t){this.listeners.get(e)?.forEach(i=>i(...t));const n=this.onceListeners.get(e);n&&(n.forEach(i=>i(...t)),this.onceListeners.delete(e))}}const v=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__,g=globalThis,A="10.27.0";function J(){return O(g),g}function O(s){const e=s.__SENTRY__=s.__SENTRY__||{};return e.version=e.version||A,e[A]=e[A]||{}}function R(s,e,t=g){const n=t.__SENTRY__=t.__SENTRY__||{},i=n[A]=n[A]||{};return i[s]||(i[s]=e())}const ve="Sentry Logger ",V={};function be(s){if(!("console"in g))return s();const e=g.console,t={},n=Object.keys(V);n.forEach(i=>{const r=V[i];t[i]=e[i],e[i]=r});try{return s()}finally{n.forEach(i=>{e[i]=t[i]})}}function we(){L().enabled=!0}function Ae(){L().enabled=!1}function j(){return L().enabled}function Ee(...s){k("log",...s)}function Te(...s){k("warn",...s)}function Ce(...s){k("error",...s)}function k(s,...e){v&&j()&&be(()=>{g.console[s](`${ve}[${s}]:`,...e)})}function L(){return v?R("loggerSettings",()=>({enabled:!1})):{enabled:!1}}const C={enable:we,disable:Ae,isEnabled:j,log:Ee,warn:Te,error:Ce},Pe=Object.prototype.toString;function De(s,e){return Pe.call(s)===`[object ${e}]`}function Ie(s){return De(s,"Object")}function Oe(s){return!!(s?.then&&typeof s.then=="function")}function Re(s,e,t){try{Object.defineProperty(s,e,{value:t,writable:!0,configurable:!0})}catch{v&&C.log(`Failed to add non-enumerable property "${e}" to object`,s)}}function ke(s,e=0){return typeof s!="string"||e===0||s.length<=e?s:`${s.slice(0,e)}...`}function Le(){const s=g;return s.crypto||s.msCrypto}let U;function Ue(){return Math.random()*16}function E(s=Le()){try{if(s?.randomUUID)return s.randomUUID().replace(/-/g,"")}catch{}return U||(U="10000000100040008000"+1e11),U.replace(/[018]/g,e=>(e^(Ue()&15)>>e/4).toString(16))}const z=1e3;function W(){return Date.now()/z}function Me(){const{performance:s}=g;if(!s?.now||!s.timeOrigin)return W;const e=s.timeOrigin;return()=>(e+s.now())/z}let Y;function Ke(){return(Y??(Y=Me()))()}function Ne(s,e={}){if(e.user&&(!s.ipAddress&&e.user.ip_address&&(s.ipAddress=e.user.ip_address),!s.did&&!e.did&&(s.did=e.user.id||e.user.email||e.user.username)),s.timestamp=e.timestamp||Ke(),e.abnormal_mechanism&&(s.abnormal_mechanism=e.abnormal_mechanism),e.ignoreDuration&&(s.ignoreDuration=e.ignoreDuration),e.sid&&(s.sid=e.sid.length===32?e.sid:E()),e.init!==void 0&&(s.init=e.init),!s.did&&e.did&&(s.did=`${e.did}`),typeof e.started=="number"&&(s.started=e.started),s.ignoreDuration)s.duration=void 0;else if(typeof e.duration=="number")s.duration=e.duration;else{const t=s.timestamp-s.started;s.duration=t>=0?t:0}e.release&&(s.release=e.release),e.environment&&(s.environment=e.environment),!s.ipAddress&&e.ipAddress&&(s.ipAddress=e.ipAddress),!s.userAgent&&e.userAgent&&(s.userAgent=e.userAgent),typeof e.errors=="number"&&(s.errors=e.errors),e.status&&(s.status=e.status)}function X(s,e,t=2){if(!e||typeof e!="object"||t<=0)return e;if(s&&Object.keys(e).length===0)return s;const n={...s};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=X(n[i],e[i],t-1));return n}function Q(){return E()}const M="_sentrySpan";function Z(s,e){e?Re(s,M,e):delete s[M]}function ee(s){return s[M]}const Be=100;class S{constructor(){this._notifyingListeners=!1,this._scopeListeners=[],this._eventProcessors=[],this._breadcrumbs=[],this._attachments=[],this._user={},this._tags={},this._attributes={},this._extra={},this._contexts={},this._sdkProcessingMetadata={},this._propagationContext={traceId:Q(),sampleRand:Math.random()}}clone(){const e=new S;return e._breadcrumbs=[...this._breadcrumbs],e._tags={...this._tags},e._attributes={...this._attributes},e._extra={...this._extra},e._contexts={...this._contexts},this._contexts.flags&&(e._contexts.flags={values:[...this._contexts.flags.values]}),e._user=this._user,e._level=this._level,e._session=this._session,e._transactionName=this._transactionName,e._fingerprint=this._fingerprint,e._eventProcessors=[...this._eventProcessors],e._attachments=[...this._attachments],e._sdkProcessingMetadata={...this._sdkProcessingMetadata},e._propagationContext={...this._propagationContext},e._client=this._client,e._lastEventId=this._lastEventId,Z(e,ee(this)),e}setClient(e){this._client=e}setLastEventId(e){this._lastEventId=e}getClient(){return this._client}lastEventId(){return this._lastEventId}addScopeListener(e){this._scopeListeners.push(e)}addEventProcessor(e){return this._eventProcessors.push(e),this}setUser(e){return this._user=e||{email:void 0,id:void 0,ip_address:void 0,username:void 0},this._session&&Ne(this._session,{user:e}),this._notifyScopeListeners(),this}getUser(){return this._user}setTags(e){return this._tags={...this._tags,...e},this._notifyScopeListeners(),this}setTag(e,t){return this.setTags({[e]:t})}setAttributes(e){return this._attributes={...this._attributes,...e},this._notifyScopeListeners(),this}setAttribute(e,t){return this.setAttributes({[e]:t})}removeAttribute(e){return e in this._attributes&&(delete this._attributes[e],this._notifyScopeListeners()),this}setExtras(e){return this._extra={...this._extra,...e},this._notifyScopeListeners(),this}setExtra(e,t){return this._extra={...this._extra,[e]:t},this._notifyScopeListeners(),this}setFingerprint(e){return this._fingerprint=e,this._notifyScopeListeners(),this}setLevel(e){return this._level=e,this._notifyScopeListeners(),this}setTransactionName(e){return this._transactionName=e,this._notifyScopeListeners(),this}setContext(e,t){return t===null?delete this._contexts[e]:this._contexts[e]=t,this._notifyScopeListeners(),this}setSession(e){return e?this._session=e:delete this._session,this._notifyScopeListeners(),this}getSession(){return this._session}update(e){if(!e)return this;const t=typeof e=="function"?e(this):e,n=t instanceof S?t.getScopeData():Ie(t)?e:void 0,{tags:i,attributes:r,extra:a,user:u,contexts:l,level:d,fingerprint:o=[],propagationContext:h}=n||{};return this._tags={...this._tags,...i},this._attributes={...this._attributes,...r},this._extra={...this._extra,...a},this._contexts={...this._contexts,...l},u&&Object.keys(u).length&&(this._user=u),d&&(this._level=d),o.length&&(this._fingerprint=o),h&&(this._propagationContext=h),this}clear(){return this._breadcrumbs=[],this._tags={},this._attributes={},this._extra={},this._user={},this._contexts={},this._level=void 0,this._transactionName=void 0,this._fingerprint=void 0,this._session=void 0,Z(this,void 0),this._attachments=[],this.setPropagationContext({traceId:Q(),sampleRand:Math.random()}),this._notifyScopeListeners(),this}addBreadcrumb(e,t){const n=typeof t=="number"?t:Be;if(n<=0)return this;const i={timestamp:W(),...e,message:e.message?ke(e.message,2048):e.message};return this._breadcrumbs.push(i),this._breadcrumbs.length>n&&(this._breadcrumbs=this._breadcrumbs.slice(-n),this._client?.recordDroppedEvent("buffer_overflow","log_item")),this._notifyScopeListeners(),this}getLastBreadcrumb(){return this._breadcrumbs[this._breadcrumbs.length-1]}clearBreadcrumbs(){return this._breadcrumbs=[],this._notifyScopeListeners(),this}addAttachment(e){return this._attachments.push(e),this}clearAttachments(){return this._attachments=[],this}getScopeData(){return{breadcrumbs:this._breadcrumbs,attachments:this._attachments,contexts:this._contexts,tags:this._tags,attributes:this._attributes,extra:this._extra,user:this._user,level:this._level,fingerprint:this._fingerprint||[],eventProcessors:this._eventProcessors,propagationContext:this._propagationContext,sdkProcessingMetadata:this._sdkProcessingMetadata,transactionName:this._transactionName,span:ee(this)}}setSDKProcessingMetadata(e){return this._sdkProcessingMetadata=X(this._sdkProcessingMetadata,e,2),this}setPropagationContext(e){return this._propagationContext=e,this}getPropagationContext(){return this._propagationContext}captureException(e,t){const n=t?.event_id||E();if(!this._client)return v&&C.warn("No client configured on scope - will not capture exception!"),n;const i=new Error("Sentry syntheticException");return this._client.captureException(e,{originalException:e,syntheticException:i,...t,event_id:n},this),n}captureMessage(e,t,n){const i=n?.event_id||E();if(!this._client)return v&&C.warn("No client configured on scope - will not capture message!"),i;const r=n?.syntheticException??new Error(e);return this._client.captureMessage(e,t,{originalException:e,syntheticException:r,...n,event_id:i},this),i}captureEvent(e,t){const n=t?.event_id||E();return this._client?(this._client.captureEvent(e,{...t,event_id:n},this),n):(v&&C.warn("No client configured on scope - will not capture event!"),n)}_notifyScopeListeners(){this._notifyingListeners||(this._notifyingListeners=!0,this._scopeListeners.forEach(e=>{e(this)}),this._notifyingListeners=!1)}}function $e(){return R("defaultCurrentScope",()=>new S)}function Ge(){return R("defaultIsolationScope",()=>new S)}class qe{constructor(e,t){let n;e?n=e:n=new S;let i;t?i=t:i=new S,this._stack=[{scope:n}],this._isolationScope=i}withScope(e){const t=this._pushScope();let n;try{n=e(t)}catch(i){throw this._popScope(),i}return Oe(n)?n.then(i=>(this._popScope(),i),i=>{throw this._popScope(),i}):(this._popScope(),n)}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getIsolationScope(){return this._isolationScope}getStackTop(){return this._stack[this._stack.length-1]}_pushScope(){const e=this.getScope().clone();return this._stack.push({client:this.getClient(),scope:e}),e}_popScope(){return this._stack.length<=1?!1:!!this._stack.pop()}}function b(){const s=J(),e=O(s);return e.stack=e.stack||new qe($e(),Ge())}function Fe(s){return b().withScope(s)}function He(s,e){const t=b();return t.withScope(()=>(t.getStackTop().scope=s,e(s)))}function te(s){return b().withScope(()=>s(b().getIsolationScope()))}function xe(){return{withIsolationScope:te,withScope:Fe,withSetScope:He,withSetIsolationScope:(s,e)=>te(e),getCurrentScope:()=>b().getScope(),getIsolationScope:()=>b().getIsolationScope()}}function Je(s){const e=O(s);return e.acs?e.acs:xe()}function Ve(){const s=J();return Je(s).getCurrentScope()}function St(s){}function je(s,e){return Ve().captureException(s,void 0)}class se{constructor(e){this.apiClient=e}async init(e){return this.apiClient.post("/v1/configs/init",e)}async fetch(e){return this.apiClient.post("/v1/configs/fetch",e)}}class ne{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/ab-tests")}async getActive(){return this.apiClient.get("/v1/ab-tests/active")}async getById(e){return this.apiClient.get(`/v1/ab-tests/${e}`)}async getVariant(e){return this.apiClient.get(`/v1/ab-tests/${e}/variant`)}async create(e){return this.apiClient.post("/v1/ab-tests",e)}async update(e,t){return this.apiClient.request(`/v1/ab-tests/${e}`,{method:"PUT",body:JSON.stringify(t)})}async patch(e,t){return this.apiClient.request(`/v1/ab-tests/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.apiClient.request(`/v1/ab-tests/${e}`,{method:"DELETE"})}}class ie{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/remote-configs")}async getById(e){return this.apiClient.get(`/v1/remote-configs/${e}`)}async create(e){return this.apiClient.post("/v1/remote-configs",e)}async update(e,t){return this.apiClient.request(`/v1/remote-configs/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.apiClient.request(`/v1/remote-configs/${e}`,{method:"DELETE"})}async refresh(){return this.apiClient.post("/v1/remote-configs/refresh",{})}}class re{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/segments")}async getById(e){return this.apiClient.get(`/v1/segments/${e}`)}async getUserSegments(){return this.apiClient.get("/v1/segments/user")}async create(e){return this.apiClient.post("/v1/segments",e)}async update(e,t){return this.apiClient.request(`/v1/segments/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.apiClient.request(`/v1/segments/${e}`,{method:"DELETE"})}}class oe{constructor(e){this.getAuthToken=e}buildUrl(e){const t=m.authUrl.replace(/\/+$/,""),n=e.replace(/^\/+/,"");return`${t}/${n}`}async request(e,t={}){const n=this.buildUrl(e),i=this.getAuthToken(),r={"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`);const a=await fetch(n,{...t,headers:r,credentials:"include"});if(!a.ok){const l=await a.text();let d=`Request failed with status ${a.status}`;try{const o=JSON.parse(l);Array.isArray(o.message)?d=o.message.join(", "):o.message?d=o.message:o.error&&(d=o.error)}catch{}throw new Error(d)}const u=await a.text();return u?JSON.parse(u):null}async getAll(){return this.request("/v1/users")}async getById(e){return this.request(`/v1/users/${e}`)}async search(e){return this.request(`/v1/users/search?q=${encodeURIComponent(e)}`)}async create(e){return this.request("/v1/users",{method:"POST",body:JSON.stringify(e)})}async update(e,t){return this.request(`/v1/users/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async delete(e){return this.request(`/v1/users/${e}`,{method:"DELETE"})}}class ae{constructor(e){this.apiClient=e}async getVersion(){return this.apiClient.get("/v1")}async check(){return this.apiClient.get("/v1/health")}async detailed(){return this.apiClient.get("/v1/health/detailed")}}class ce{constructor(e){this.getAuthToken=e}buildUrl(e){const t=m.authUrl.replace(/\/+$/,""),n=e.replace(/^\/+/,"");return`${t}/${n}`}async request(e,t={}){const n=this.buildUrl(e),i=this.getAuthToken(),r={"Content-Type":"application/json",...t.headers};i&&(r.Authorization=`Bearer ${i}`);const a=await fetch(n,{...t,headers:r,credentials:"include"});if(!a.ok){const l=await a.text();let d=`Request failed with status ${a.status}`;try{const o=JSON.parse(l);Array.isArray(o.message)?d=o.message.join(", "):o.message?d=o.message:o.error&&(d=o.error)}catch(o){console.error("[AuthApiClient] Error parsing error response:",o,"Raw:",l)}throw console.error("[AuthApiClient] Request failed:",{url:n,status:a.status,message:d}),new Error(d)}const u=await a.text();if(!u)return null;try{return JSON.parse(u)}catch(l){return console.warn("[AuthApiClient] Response is not JSON, returning as text:",l),u}}async guest(e){return this.request("/v1/auth/guest",{method:"POST",body:JSON.stringify({deviceId:e})})}async login(e){return this.request("/v1/auth/login",{method:"POST",body:JSON.stringify(e)})}async register(e){return this.request("/v1/auth/registration",{method:"POST",body:JSON.stringify(e)})}async logout(){return this.request("/v1/auth/logout",{method:"POST"})}async getMe(){return this.request("/v1/auth/me",{method:"GET"})}async refresh(){return this.request("/v1/auth/refresh",{method:"POST"})}async googleLogin(e){return this.request("/v1/auth/google",{method:"POST",body:JSON.stringify({idToken:e})})}async health(){return this.request("/v1/health",{method:"GET"})}}class ue{constructor(e){this.apiClient=e}async health(){return this.apiClient.get("/v1/kv/health")}async list(){return this.apiClient.get("/v1/kv/list")}async get(e){return this.apiClient.get(`/v1/kv/get/${encodeURIComponent(e)}`)}async set(e,t){const n={key:e,value:t};return this.apiClient.post("/v1/kv/set",n)}async delete(e){return this.apiClient.delete(`/v1/kv/${encodeURIComponent(e)}`)}async exists(e){try{return await this.get(e),!0}catch(t){return console.debug("[KVApiClient] exists check failed for key:",e,t),!1}}async getMany(e){const t={},n=e.map(async i=>{try{const r=await this.get(i);t[i]=r.value}catch(r){console.debug("[KVApiClient] getMany failed for key:",i,r),t[i]=null}});return await Promise.all(n),t}async setMany(e){const t=Object.entries(e).map(([n,i])=>this.set(n,i));await Promise.all(t)}async deleteMany(e){const t=e.map(n=>this.delete(n));await Promise.all(t)}}class ze{constructor(e){this.apiClient=e}async getAll(){return this.apiClient.get("/v1/events")}async send(e){return this.apiClient.post("/v1/events",e)}}const P="1.0.25",D=[P,"1.0.3","1.0.0"];function de(s){return D.includes(s)}function le(s){if(!de(s)){const e=D.join(", ");throw new Error(`[SDK] Unsupported version "${s}". Supported versions: ${e}. Current SDK version: ${P}`)}}const he=()=>typeof window<"u"&&typeof navigator<"u",We=()=>he()&&navigator.userAgent||"",Ye=s=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(s),Xe=()=>{if(!he())return{env:"unknown"};const s=window,e=We(),t=s?.cordova,n=typeof t?.platformId=="string"?t.platformId:void 0;return t?n==="ios"?{env:"cordova-ios",platformId:n,userAgent:e}:n==="android"?{env:"cordova-android",platformId:n,userAgent:e}:{env:"unknown",platformId:n,userAgent:e}:{env:Ye(e)?"web-mobile":"web-desktop",userAgent:e}},Qe=s=>{const e=s?.get?.("ads")??null;if(!e||typeof e!="object")return null;const t=!!e.enabled,n=e.placements;return!n||typeof n!="object"?null:{enabled:t,defaults:e.defaults,mediators:e.mediators,placements:n}},Ze=s=>s==="cordova-ios"||s==="cordova-android"?"cordova":s==="web-mobile"||s==="web-desktop"?"web":null,et=(s,e)=>({placement:s,type:e,isReady:!1,isLoading:!1,readyTime:null,lastLoadStartTime:null,lastShowTime:null,retryCount:0,lastErrorCode:null,lastErrorMessage:null,stats:{totalLoads:0,successfulLoads:0,totalShows:0,totalRewards:0}}),tt=(s,e,t)=>s==="linear"?t*e:s==="exponential"?t*Math.pow(2,e-1):0,st=(s,e,t)=>{let n;return Promise.race([s,new Promise((i,r)=>{n=setTimeout(()=>r(t),e)})]).finally(()=>clearTimeout(n))},nt=(s,e)=>{if(s.isReady)return Promise.resolve(!0);const t=Date.now();return new Promise(n=>{const i=()=>{if(s.isReady)return n(!0);if(Date.now()-t>=e)return n(!1);setTimeout(i,100)};i()})},ge={},it=(s,e)=>{ge[s]=e},rt=s=>ge[s]?.()??null;class ot{constructor(e){this.deps=e,this.enabled=!1,this.mediator=null,this.mediatorId=null,this.environment="unknown",this.placements=new Map,this.showingPlacement=null}async init(){const{env:e,platformId:t,userAgent:n}=Xe();this.environment=e,this.deps.logger?.info?.("[AdManager] init start",{env:e,platformId:t,userAgent:n}),this.deps.eventBus?.emit?.("ads.init.start",{env:e});const i=Qe(this.deps.configService);if(!i){this.enabled=!1,this.deps.logger?.warn?.("[AdManager] ads config missing"),this.deps.eventBus?.emit?.("ads.init.failed",{env:e,reason:"NO_CONFIG"});return}if(!i.enabled){this.enabled=!1,this.deps.logger?.info?.("[AdManager] ads disabled by config");return}const r=Ze(this.environment);if(!r){this.enabled=!1,this.deps.logger?.warn?.("[AdManager] unknown environment branch",{env:this.environment}),this.deps.eventBus?.emit?.("ads.init.failed",{env:e,reason:"UNKNOWN_ENV"});return}const a=Object.values(i.placements);if(!a.length){this.enabled=!1,this.deps.logger?.warn?.("[AdManager] no placements defined"),this.deps.eventBus?.emit?.("ads.init.failed",{env:e,reason:"NO_PLACEMENTS"});return}const l=a[0]?.[r]?.mediator;if(!l){this.enabled=!1,this.deps.logger?.warn?.("[AdManager] mediator not defined for branch",{branch:r}),this.deps.eventBus?.emit?.("ads.init.failed",{env:e,reason:"NO_MEDIATOR"});return}const d=rt(l);if(!d){this.enabled=!1,this.deps.logger?.error?.("[AdManager] mediator not registered",{mediatorId:l}),this.deps.eventBus?.emit?.("ads.init.failed",{env:e,reason:"MEDIATOR_NOT_REGISTERED"});return}this.mediator=d,this.mediatorId=l;try{await d.init(i,this.environment)}catch(o){this.enabled=!1,this.deps.logger?.error?.("[AdManager] mediator init failed",{mediatorId:l,err:o}),this.deps.eventBus?.emit?.("ads.init.failed",{env:this.environment,reason:"MEDIATOR_INIT_FAILED"});return}this.enabled=!0,this.deps.logger?.info?.("[AdManager] ads enabled",{env:e,branch:r}),this.deps.eventBus?.emit?.("ads.init.success",{env:e,branch:r});for(const[o,h]of Object.entries(i.placements))this.getPlacementState(o,h.type);if(i.defaults?.preloadOnStart)for(const[o,h]of Object.entries(i.placements))this.preloadPlacement(o,h,i).catch(w=>{this.deps.logger?.warn?.("[AdManager] preload failed",{placement:o,err:w})})}getEnv(){return this.environment}async showAd(e,t,n){const i=Date.now();if(!this.enabled){const o={status:"SDK_DISABLED",type:e,placement:t,canReward:!1,timestamp:i};return n?.(o),o}if(!this.mediator){const o={status:"SDK_DISABLED",type:e,placement:t,canReward:!1,errorMessage:"Ad mediator not set",timestamp:i};return n?.(o),o}if(this.showingPlacement){const o={status:"SHOW_FAILED",type:e,placement:t,canReward:!1,errorMessage:"Ad already showing",timestamp:i};return n?.(o),o}const r=this.deps.configService?.get?.("ads")??null,a=r?.placements?.[t];if(!a||a.type!==e){const o={status:"NO_CONFIG",type:e,placement:t,canReward:!1,timestamp:i};return n?.(o),o}const u=this.getPlacementState(t,e),l=r?.defaults?.loadTimeoutMs??15e3;if(this.deps.eventBus?.emit?.("ads.show.request",{placement:t,type:e}),!u.isReady&&(this.preloadPlacement(t,a,r).catch(()=>{}),!await nt(u,l))){const h={status:"NOT_READY",type:e,placement:t,canReward:!1,errorCode:"LOAD_TIMEOUT",errorMessage:`Ad not ready after ${l}ms`,timestamp:Date.now()};return n?.(h),h}this.showingPlacement=t,u.lastShowTime=Date.now(),u.stats.totalShows++,this.deps.eventBus?.emit?.("ads.show.start",{placement:t,type:e});const d=r?.defaults?.showTimeoutMs??15e3;return new Promise(o=>{let h=!1;const w=f=>{h||(h=!0,this.showingPlacement=null,u.isReady=!1,n?.(f),o(f),this.preloadPlacement(t,a,r).catch(()=>{}))},mt=setTimeout(()=>{w({status:"TIMEOUT",type:e,placement:t,canReward:!1,timestamp:Date.now()})},d);this.mediator.show(e,t,a,f=>{clearTimeout(mt),f.status==="REWARD_GRANTED"&&(u.stats.totalRewards++,this.deps.eventBus?.emit?.("ads.reward.granted",{placement:t,rewardType:f.rewardType,rewardAmount:f.rewardAmount})),this.deps.eventBus?.emit?.(`ads.show.${f.status.toLowerCase()}`,{placement:t,type:e}),w({...f,type:e,placement:t,timestamp:Date.now()})})})}getPlacementState(e,t){let n=this.placements.get(e);return n||(n=et(e,t),this.placements.set(e,n)),n}async preloadPlacement(e,t,n){const i=this.getPlacementState(e,t.type);if(i.isReady||i.isLoading)return;i.isLoading=!0,i.lastLoadStartTime=Date.now(),i.stats.totalLoads++,this.deps.eventBus?.emit?.("ads.placement.preload.start",{placement:e});const r=n.defaults?.retry,a=r?.strategy??"none",u=r?.maxAttempts??0,l=r?.baseDelayMs??0,d=n.defaults?.loadTimeoutMs??15e3;for(;;)try{await st(this.mediator.load(t.type,e,t),d,new Error("LOAD_TIMEOUT")),i.isReady=!0,i.isLoading=!1,i.retryCount=0,i.readyTime=Date.now(),i.stats.successfulLoads++,this.deps.eventBus?.emit?.("ads.placement.preload.success",{placement:e});return}catch(o){if(i.retryCount++,i.lastErrorCode=o?.code??"LOAD_FAILED",i.lastErrorMessage=o?.message??"Ad load failed",this.deps.eventBus?.emit?.("ads.placement.preload.failed",{placement:e,errorCode:i.lastErrorCode,errorMessage:i.lastErrorMessage}),i.retryCount>u||a==="none"){i.isLoading=!1;return}const h=tt(a,i.retryCount,l);await new Promise(w=>setTimeout(w,h))}}setMediator(e){this.mediator=e}}class at{constructor(){this.store=new Map}get(e){return this.store.has(e)?this.store.get(e):null}set(e,t){this.store.set(e,t)}replace(e){this.store.clear();for(const[t,n]of Object.entries(e))this.store.set(t,n)}}const T={AUTH_OPEN:"core:authWindowOpen",AUTH_CLOSE:"core:authWindowClose",AUTH_POPUP_SHOW:"core:authPopupShow",AUTH_POPUP_HIDE:"core:authPopupHide",AUTH_SUCCESS:"core:authSuccess"};class y{constructor(){this.eventBus=new x,this.systemParams={},this.initialized=!1,this.ads={registerMediator:it},this.detectEnvironment(),this.apiClient=new H(()=>this.systemParams.authToken),this.configs=new se(this.apiClient),this.abTests=new ne(this.apiClient),this.remoteConfigs=new ie(this.apiClient),this.segments=new re(this.apiClient),this.users=new oe(()=>this.systemParams.authToken),this.health=new ae(this.apiClient),this.auth=new ce(()=>this.systemParams.authToken),this.kv=new ue(this.apiClient),this.events=new ze(this.apiClient),this.configStore=new at,this.adManager=new ot({configService:this.configStore,eventBus:this.eventBus,logger:console})}static getInstance(){return y.instance||(y.instance=new y),y.instance}async init(e){if(console.log(`[SDK] v${P} init: start`,e),e?.version){console.log(`[SDK] init: validating app version "${e.version}"...`);try{le(e.version),console.log(`[SDK] init: app version "${e.version}" is supported`)}catch(n){throw console.error(`[SDK] init: VERSION ERROR - ${n.message}`),console.error(`[SDK] init: Supported versions: ${D.join(", ")}`),n}}const t=this.getStoredToken();if(t&&!this.systemParams.authToken&&(console.log("[SDK] init: RESTORING TOKEN FROM LOCALSTORAGE"),this.systemParams.authToken=t),this.systemParams.authToken){console.log("[SDK] init: TOKEN ALREADY SET → SKIP GUEST AUTH"),this.profileClient=new F(()=>this.systemParams.authToken,this.eventBus),this.initialized=!0,e?.authPopup&&console.log("[SDK] init: authPopup=true, but already authenticated");return}if(!this.initialized)try{e?.baseUrl&&(console.log("[SDK] init: set base url ->",e.baseUrl),B(e.baseUrl)),e?.authUrl&&(console.log("[SDK] init: set auth url ->",e.authUrl),$(e.authUrl)),console.log("[SDK] init: set system params ->",e),e&&this.setSystemParams(e),console.log("[SDK] init: ensure device id…");const n=await this.ensureDeviceId();if(console.log("[SDK] init: deviceId =",n),this.systemParams.deviceId=n,e?.authPopup?console.log("[SDK] init: authPopup=true, skipping auto guest auth, will show popup"):e?.skipAuth?console.log("[SDK] init: skipAuth=true, skipping guest auth"):(console.log("[SDK] init: guest auth…"),await this.authGuest(),console.log("[SDK] init: guest auth OK")),this.profileClient=new F(()=>this.systemParams.authToken,this.eventBus),console.log("[SDK] init: profile module initialized"),this.on(I.PROFILE_UPDATED,i=>{try{const r=i?.gid??i?.detail?.gid;r&&(console.log("[SDK] profile cache invalidated for",r),this.profileClient.invalidate(r))}catch(r){console.error("[SDK] profile cache invalidation error:",r)}}),this.initialized=!0,console.log("[SDK] init: COMPLETE"),await this.initAds(),this.eventBus.emit("core:initialized",this.getSystemParams()),e?.authPopup){console.log("[SDK] init: authPopup=true, isAuthenticated =",this.isAuthenticated()),console.log("[SDK] init: authToken =",this.systemParams.authToken);const i=this.showAuthPopupIfNeeded();console.log("[SDK] init: popup shown =",i)}}catch(n){throw console.error("[SDK] init: ERROR",n),this.captureError(n),n}}captureError(e){try{je(e)}catch(t){console.error("[SDK] Sentry capture error:",t)}}async authGuest(){try{console.log("[SDK] authGuest: start");const e=this.getStoredToken();if(e){this.systemParams.authToken=e;return}console.log("[SDK] authGuest: sending POST /v1/auth/guest",{deviceId:this.systemParams.deviceId});const t=await this.auth.guest(this.systemParams.deviceId);console.log("[SDK] authGuest: server response",t);const n=t?.accessToken??t?.data?.accessToken??null;if(!n)throw console.error("[SDK] authGuest: ERROR missing token",t),new Error("Guest auth failed: missing token");this.storeToken(n),this.systemParams.authToken=n}catch(e){throw console.error("[SDK] authGuest: ERROR",e),this.captureError(e),e}}setSystemParams(e){this.systemParams={...this.systemParams,...e}}getSystemParams(){return{...this.systemParams}}get api(){return this.apiClient}on(e,t){this.eventBus.on(e,t)}once(e,t){this.eventBus.once(e,t)}off(e,t){this.eventBus.off(e,t)}emit(e,...t){this.eventBus.emit(e,...t)}detectEnvironment(){const e=typeof navigator<"u"?navigator.userAgent:"",t=typeof window<"u"&&typeof window.cordova<"u";this.systemParams.os=this.detectOS(e),this.systemParams.isCordova=t}detectOS(e){return/android/i.test(e)?"android":/iPad|iPhone|iPod/i.test(e)?"ios":/Win/i.test(e)?"windows":/Mac/i.test(e)?"macos":/Linux/i.test(e)?"linux":"unknown"}async ensureDeviceId(){const e=this.getStoredDeviceId();if(e)return e;const t=await this.tryGetCordovaDeviceId();if(t)return this.storeDeviceId(t),t;const n=this.generateGuid();return this.storeDeviceId(n),n}getStoredDeviceId(){try{return localStorage.getItem("coreSDK_deviceId")}catch(e){return console.error("[SDK] getStoredDeviceId error:",e),null}}storeDeviceId(e){try{localStorage.setItem("coreSDK_deviceId",e)}catch(t){console.error("[SDK] storeDeviceId error:",t)}}getStoredToken(){try{return localStorage.getItem("coreSDK_token")}catch(e){return console.error("[SDK] getStoredToken error:",e),null}}storeToken(e){try{localStorage.setItem("coreSDK_token",e)}catch(t){console.error("[SDK] storeToken error:",t)}}setUser(e){this.systemParams.user=e}async login(e){try{console.log("[SDK] login: start",{email:e.email});const t=await this.auth.login(e);console.log("[SDK] login: server response received");const n=t?.accessToken??null;if(!n)throw console.error("[SDK] login: ERROR missing token",t),new Error("Login failed: missing token");return this.storeToken(n),this.systemParams.authToken=n,t.user&&this.setUser(t.user),t}catch(t){throw console.error("[SDK] login: ERROR",t),this.captureError(t),t}}async register(e){try{console.log("[SDK] register: start",{email:e.email,username:e.username});const t=await this.auth.register(e);if(console.log("[SDK] register: server response received"),!t)throw console.error("[SDK] register: ERROR missing user data"),new Error("Registration failed: missing user data");return t}catch(t){throw console.error("[SDK] register: ERROR",t),this.captureError(t),t}}async logout(){try{console.log("[SDK] logout: start");try{await this.auth.logout()}catch(e){console.warn("[SDK] logout endpoint error (ignored):",e)}this.clearToken(),this.systemParams.authToken=void 0,this.systemParams.user=null,console.log("[SDK] logout: COMPLETE")}catch(e){throw console.error("[SDK] logout: ERROR",e),this.captureError(e),e}}clearToken(){try{localStorage.removeItem("coreSDK_token")}catch(e){console.error("[SDK] clearToken error:",e)}}async tryGetCordovaDeviceId(){if(typeof window>"u")return null;const e=window;return e.device?.uuid?String(e.device.uuid):null}generateGuid(){const e=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`}get profile(){return this.profileClient}isAuthenticated(){return!!this.systemParams.authToken}showAuthPopupIfNeeded(){return this.isAuthenticated()?!1:(this.showAuthPopup(),!0)}showAuthPopup(){console.log("[SDK] showAuthPopup: emitting event"),this.eventBus.emit(T.AUTH_POPUP_SHOW)}hideAuthPopup(){console.log("[SDK] hideAuthPopup: emitting event"),this.eventBus.emit(T.AUTH_POPUP_HIDE)}async loginAsGuest(){try{console.log("[SDK] loginAsGuest: start"),await this.ensureDeviceId(),await this.authGuest(),this.hideAuthPopup(),this.eventBus.emit(T.AUTH_SUCCESS,{type:"guest"}),console.log("[SDK] loginAsGuest: SUCCESS")}catch(e){throw console.error("[SDK] loginAsGuest: ERROR",e),e}}async loginWithGoogle(e){try{console.log("[SDK] loginWithGoogle: start");const t=await this.auth.googleLogin(e),n=t?.accessToken??null;if(!n)throw new Error("Google login failed: missing token");this.storeToken(n),this.systemParams.authToken=n,t.user&&this.setUser(t.user),this.hideAuthPopup(),this.eventBus.emit(T.AUTH_SUCCESS,{type:"google"}),console.log("[SDK] loginWithGoogle: SUCCESS")}catch(t){throw console.error("[SDK] loginWithGoogle: ERROR",t),t}}showAd(e,t,n){return this.adManager.showAd(e,t,n)}async initAds(){await this.adManager.init()}__setConfigForTests(e,t){this.configStore.set(e,t)}__setAdsMediatorForTests(e){this.adManager.setMediator(e)}}const ct=s=>Object.freeze({init:s.init.bind(s),initAds:s.initAds.bind(s),showAd:s.showAd.bind(s),getSystemParams:s.getSystemParams.bind(s),isAuthenticated:s.isAuthenticated.bind(s),on:s.on.bind(s),off:s.off.bind(s),configs:{init:s.configs.init.bind(s.configs),fetch:s.configs.fetch.bind(s.configs)},kv:{list:()=>s.kv.list()},ads:{registerMediator:s.ads.registerMediator.bind(s.ads)},__setConfigForTests:s.__setConfigForTests.bind(s)}),ut=y.getInstance(),fe=ct(ut),_=[{name:"core",description:"Core SDK methods",enabled:!0,methods:[{name:"init",description:"Initialize SDK",enabled:!0},{name:"getSystemParams",description:"Get system parameters",enabled:!0},{name:"setSystemParams",description:"Set system parameters",enabled:!0},{name:"isAuthenticated",description:"Check if user is authenticated",enabled:!0}]},{name:"auth",description:"Authentication methods",enabled:!0,methods:[{name:"login",description:"Login with email/password",enabled:!0},{name:"register",description:"Register new user",enabled:!0},{name:"logout",description:"Logout user",enabled:!0},{name:"authGuest",description:"Authenticate as guest",enabled:!0},{name:"loginAsGuest",description:"Login as guest (with popup)",enabled:!0},{name:"loginWithGoogle",description:"Login with Google",enabled:!0}]},{name:"authPopup",description:"Auth popup methods",enabled:!0,methods:[{name:"showAuthPopup",description:"Show auth popup",enabled:!0},{name:"hideAuthPopup",description:"Hide auth popup",enabled:!0},{name:"showAuthPopupIfNeeded",description:"Show popup if not authenticated",enabled:!0}]},{name:"events",description:"Event bus methods",enabled:!0,methods:[{name:"on",description:"Subscribe to event",enabled:!0},{name:"off",description:"Unsubscribe from event",enabled:!0},{name:"once",description:"Subscribe to event once",enabled:!0},{name:"emit",description:"Emit event",enabled:!0}]},{name:"profile",description:"User profile methods",enabled:!0,methods:[{name:"profile.get",description:"Get user profile",enabled:!0},{name:"profile.update",description:"Update user profile",enabled:!0},{name:"profile.invalidate",description:"Invalidate profile cache",enabled:!0}]},{name:"configs",description:"Configs API client",enabled:!0,methods:[{name:"configs.getAll",description:"Get all configs",enabled:!0},{name:"configs.get",description:"Get config by key",enabled:!0}]},{name:"abTests",description:"A/B Tests API client",enabled:!0,methods:[{name:"abTests.getAll",description:"Get all A/B tests",enabled:!0},{name:"abTests.get",description:"Get A/B test by id",enabled:!0},{name:"abTests.getVariant",description:"Get user variant",enabled:!0}]},{name:"remoteConfigs",description:"Remote Configs API client",enabled:!0,methods:[{name:"remoteConfigs.getAll",description:"Get all remote configs",enabled:!0},{name:"remoteConfigs.get",description:"Get remote config by key",enabled:!0}]},{name:"segments",description:"Segments API client",enabled:!0,methods:[{name:"segments.getAll",description:"Get all segments",enabled:!0},{name:"segments.check",description:"Check if user in segment",enabled:!0}]},{name:"users",description:"Users API client",enabled:!0,methods:[{name:"users.getMe",description:"Get current user",enabled:!0},{name:"users.update",description:"Update user data",enabled:!0}]},{name:"kv",description:"Key-Value storage API client",enabled:!0,methods:[{name:"kv.get",description:"Get value by key",enabled:!0},{name:"kv.set",description:"Set value by key",enabled:!0},{name:"kv.delete",description:"Delete value by key",enabled:!0},{name:"kv.exists",description:"Check if key exists",enabled:!0},{name:"kv.getMany",description:"Get multiple values",enabled:!0}]},{name:"health",description:"Health check API client",enabled:!0,methods:[{name:"health.check",description:"Check API health",enabled:!0}]},{name:"eventsApi",description:"Events API client (analytics)",enabled:!1,methods:[{name:"events.track",description:"Track event",enabled:!1},{name:"events.trackBatch",description:"Track batch of events",enabled:!1}]},{name:"ad",description:"Ad methods",enabled:!0,methods:[{name:"showAd",description:"Show ad for a placement",enabled:!0},{name:"initAds",description:"Initialize ads subsystem",enabled:!0},{name:"__setConfigForTests",description:"[DEV] Inject config directly into SDK",enabled:!0},{name:"__setAdsMediatorForTests",description:"[DEV] Inject ad mediator implementation",enabled:!0}]}];function dt(s){for(const e of _)if(e.enabled){for(const t of e.methods)if(t.name===s)return t.enabled}return!1}function lt(s){return _.find(t=>t.name===s)?.enabled??!1}function ht(){const s=[];for(const e of _)if(e.enabled)for(const t of e.methods)t.enabled&&s.push(t.name);return s}function gt(s){return _.find(t=>t.name===s)?.methods??[]}function ft(s,e){for(const t of _)for(const n of t.methods)if(n.name===s){n.enabled=e;return}}function pt(s,e){const t=_.find(n=>n.name===s);t&&(t.enabled=e)}typeof window<"u"&&(window.coreSDK=fe),c.AbTestsApiClient=ne,c.ApiClient=H,c.AuthApiClient=ce,c.ConfigsApiClient=se,c.CoreSDK=y,c.EventBus=x,c.HealthApiClient=ae,c.KVApiClient=ue,c.RemoteConfigsApiClient=ie,c.SDK_EVENTS=T,c.SDK_METHODS=_,c.SDK_VERSION=P,c.SUPPORTED_VERSIONS=D,c.SegmentsApiClient=re,c.UsersApiClient=oe,c.coreSDK=fe,c.getEnabledMethods=ht,c.getMethodsByCategory=gt,c.isCategoryEnabled=lt,c.isMethodEnabled=dt,c.isVersionSupported=de,c.sdkConfig=m,c.setAuthUrl=$,c.setBaseUrl=B,c.setCategoryEnabled=pt,c.setMethodEnabled=ft,c.validateVersion=le,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})}));
